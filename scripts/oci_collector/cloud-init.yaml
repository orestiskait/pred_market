#cloud-config
# Minimal OS prep so the VM is ready for setup.sh after SSH-ing in.
# cloud-config format handles apt locks and user setup natively.

system_info:
  default_user:
    name: ubuntu
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash

timezone: America/New_York

package_update: true

packages:
  - git
  - curl
  - ca-certificates
  - fail2ban
  - unattended-upgrades
  - docker-compose-plugin

runcmd:
  - curl -fsSL https://get.docker.com | sh
  - usermod -aG docker ubuntu
  - systemctl enable --now docker
  # Open port 388 for LDM upstream connections (iptables)
  - iptables -I INPUT -p tcp --dport 388 -j ACCEPT
  - iptables-save > /etc/iptables/rules.v4 || true
  - echo "[cloud-init] Done. SSH in and run setup.sh"
