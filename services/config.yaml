# ============================================================
# Services Configuration
# ============================================================
#
# Single config file for all services. Each parameter documents which
# consumer(s) use it. Paths are relative to the project root.
#
# Quick reference — which service uses which section:
#
#   Section           | Kalshi listener | Synoptic listener | Weather bot | Research scripts
#   ------------------|-----------------|-------------------|-------------|------------------
#   credentials       | ✓               | ✓                 | ✓           |
#   kalshi             | ✓               |                   | ✓           |
#   event_series       | ✓               | ✓                 | ✓           | iem_awc_data_collector, run_weather_collection
#   event_rollover     | ✓               |                   | ✓           |
#   storage            | ✓               | ✓                 | ✓           | iem_awc_data_collector, run_weather_collection, weather_discrepancy_analysis
#   collection         | ✓               |                   |             |
#   synoptic           |                 | ✓                 |             |
#   bot                |                 |                   | ✓           |
#
# Optional keys (not shown below): weather_stations (research/weather/observations.py),
#   events (services/markets/ticker.py — explicit event ticker overrides).
#
# Adding a new city/market:
#   1. Add the series prefix to `event_series` below.
#   2. Add a MarketConfig entry in services/markets/registry.py.
#   3. All services pick it up automatically.
#
# ============================================================

# =============================================================================
# CREDENTIALS (secrets in files, paths in config)
# =============================================================================
# All secrets live in files under credentials.dir. No .env needed.
# Override dir with CREDENTIALS_DIR env (e.g. /app/credentials in Docker).
#
# File layout under credentials.dir:
#   kalshi_api_key.txt   - Kalshi private key PEM
#   kalshi_api_key_id    - Kalshi API key ID (one line)
#   synoptic_token       - Synoptic API token (one line)
# =============================================================================
credentials:
  # Used by: config.py (make_kalshi_clients, get_synoptic_token)
  dir: "~/.kalshi"                    # Base dir for credential files; CREDENTIALS_DIR env overrides
  kalshi_private_key: "kalshi_api_key.txt"   # Kalshi listener, weather bot (via make_kalshi_clients)
  kalshi_api_key_id: "kalshi_api_key_id"     # Kalshi listener, weather bot (via make_kalshi_clients)
  synoptic_token: "synoptic_token"            # Synoptic listener (via get_synoptic_token)

# =============================================================================
# KALSHI API
# =============================================================================
# Used by: kalshi/listener.py, bot/weather_bot.py, config.py (make_kalshi_clients)
# =============================================================================
kalshi:
  base_url: "https://api.elections.kalshi.com/trade-api/v2"   # config.py → KalshiRestClient
  ws_url:   "wss://api.elections.kalshi.com/trade-api/ws/v2"  # kalshi/listener, weather_bot (WebSocket)

# =============================================================================
# MARKET SELECTION (event_series)
# =============================================================================
# Series prefixes (uppercase). Each service queries Kalshi for open events
# in these series and picks the active one. Registry maps each prefix to
# station IDs, timezone, city. Optional top-level `events` key can override
# with explicit event tickers (ticker.py).
# =============================================================================
event_series:
  # Used by: kalshi/listener, synoptic/listener, weather_bot, ticker.py,
  #          research/weather/iem_awc_data_collector.py, run_weather_collection
  - "KXHIGHCHI"
  - "KXHIGHNY"

# =============================================================================
# EVENT ROLLOVER
# =============================================================================
# Periodic re-discovery of event tickers as markets roll over at local
# midnight. Replaces cron-based process restarts.
# NOT used by: synoptic/listener (stations are fixed per series)
# =============================================================================
event_rollover:
  # Used by: ticker.py, kalshi/listener, weather_bot
  # "active" = today's market (earliest close_time). "next" = strike_date >=
  # today in market's local tz — enables pre-trading tomorrow's market.
  event_selection: "active"
  # Used by: kalshi/listener, weather_bot — re-query Kalshi for new events (sec). 0 = disable.
  rediscover_interval_seconds: 300

# =============================================================================
# STORAGE
# =============================================================================
# Parquet output and bot trade logs. data_dir is relative to config file.
# =============================================================================
storage:
  # Used by: kalshi/listener, synoptic/listener, weather_bot, research/weather/iem_awc_data_collector,
  #          run_weather_collection, weather_discrepancy_analysis
  data_dir: "../data"            # Relative to config file; ../data = project root
  # Used by: kalshi/listener, synoptic/listener, weather_bot
  flush_interval_seconds: 300    # Buffer flush to parquet (all services)

# =============================================================================
# KALSHI LISTENER — Snapshot collection
# =============================================================================
# Used by: kalshi/listener.py ONLY
# Controls how often and when Kalshi orderbook/ticker snapshots are written
# to Parquet. Spike detection triggers immediate snapshots on price moves.
# =============================================================================
collection:
  interval_seconds: 60           # kalshi/listener — baseline snapshot interval (seconds)
  spike_threshold_cents: 3      # kalshi/listener — snapshot when price moves ≥ this
  spike_cooldown_seconds: 2     # kalshi/listener — min sec between spike-triggered snapshots
  max_orderbook_depth: 5        # kalshi/listener — OB levels per side per contract; 0 = all
  baseline_every_n_snapshots: 60  # kalshi/listener — full OB baseline frequency; 1 = disable delta

# =============================================================================
# SYNOPTIC LISTENER — Weather data ingest
# =============================================================================
# Used by: synoptic/listener.py ONLY
# Stations are auto-derived from event_series via market registry. Override
# `stations` only if you need extra stations beyond the registry.
# =============================================================================
synoptic:
  # stations:  # optional override; omit → uses event_series → registry
  #   - KMDW1M
  #   - KNYC
  vars:        # Synoptic variables to subscribe to (e.g. air_temp)
    - air_temp

# =============================================================================
# WEATHER BOT — Paper trading strategy
# =============================================================================
# Used by: bot/weather_bot.py ONLY
# Strategy: when N consecutive 1-min ASOS obs ≥ cap_strike, buy NO contracts.
# =============================================================================
bot:
  consecutive_obs: 2             # weather_bot — consecutive obs above trigger before trade
  max_price_cents: 95            # weather_bot — max price to pay for NO contract (Kalshi=100)
  starting_balance_cents: 100000 # weather_bot — paper balance ($1,000)

