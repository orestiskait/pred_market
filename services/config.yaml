# ============================================================
# Services Configuration
# ============================================================
#
# Single config file for all services. Each parameter documents which
# consumer(s) use it. Paths are relative to the project root.
#
# Quick reference — which service uses which section:
#
#   Section           | Kalshi listener | Synoptic listener | Weather bot | Research scripts
#   ------------------|-----------------|-------------------|-------------|------------------
#   credentials       | ✓               | ✓                 | ✓           |
#   kalshi             | ✓               |                   | ✓           |
#   event_series       | kalshi_listener | synoptic_listener | weather_bot | research
#   event_rollover     | ✓               |                   | ✓           |
#   storage            | ✓               | ✓                 | ✓           | iem_awc_data_collector, run_weather_collection, weather_discrepancy_analysis
#   collection         | ✓               |                   |             |
#   synoptic           |                 | ✓                 |             |
#   bot                |                 |                   | ✓           |
#
# event_series is keyed by consumer (kalshi_listener, synoptic_listener, weather_bot, research).
# Optional keys: weather_stations (research), events (ticker.py — explicit ticker overrides).
#
# Adding a new city/market:
#   1. Add KalshiMarketConfig in services/markets/kalshi_registry.py.
#   2. Add the series prefix to event_series.<consumer> for each consumer that needs it.
#
# ============================================================

# =============================================================================
# CREDENTIALS (secrets in files, paths in config)
# =============================================================================
# All secrets live in files under credentials.dir. No .env needed.
# Override dir with CREDENTIALS_DIR env (e.g. /app/credentials in Docker).
#
# File layout under credentials.dir:
#   kalshi_api_key.txt   - Kalshi private key PEM
#   kalshi_api_key_id    - Kalshi API key ID (one line)
#   synoptic_token       - Synoptic API token (one line)
# =============================================================================
credentials:
  # Used by: config.py (make_kalshi_clients, get_synoptic_token)
  dir: "~/.kalshi"                    # Base dir for credential files; CREDENTIALS_DIR env overrides
  kalshi_private_key: "kalshi_api_key.txt"   # Kalshi listener, weather bot (via make_kalshi_clients)
  kalshi_api_key_id: "kalshi_api_key_id"     # Kalshi listener, weather bot (via make_kalshi_clients)
  synoptic_token: "synoptic_token"            # Synoptic listener (via get_synoptic_token)

# =============================================================================
# KALSHI API
# =============================================================================
# Used by: kalshi/listener.py, bot/weather_bot.py, config.py (make_kalshi_clients)
# =============================================================================
kalshi:
  base_url: "https://api.elections.kalshi.com/trade-api/v2"   # config.py → KalshiRestClient
  ws_url:   "wss://api.elections.kalshi.com/trade-api/ws/v2"  # kalshi/listener, weather_bot (WebSocket)

# =============================================================================
# EVENT SERIES — BY CONSUMER
# =============================================================================
# Each consumer explicitly lists which markets it tracks. Use YAML anchors
# (&default_series / *default_series) to share a list across consumers.
#
# Add new city: 1) Add KalshiMarketConfig in services/markets/kalshi_registry.py
#               2) Add series prefix to the consumer(s) below
#
# Consumer keys:
#   kalshi_listener  — orderbook/ticker snapshots (kalshi/listener.py)
#   synoptic_listener — Synoptic push weather ingest (synoptic/listener.py)
#   weather_bot      — paper trading (bot/weather_bot.py)
#   research         — iem_awc_data_collector, run_weather_collection,
#                      weather_discrepancy_analysis
# =============================================================================
event_series:
  default: &default_series
    - "KXHIGHCHI"
    - "KXHIGHNY"

  kalshi_listener: *default_series
  synoptic_listener: *default_series
  weather_bot: *default_series
  research: *default_series

# =============================================================================
# EVENT ROLLOVER
# =============================================================================
# Periodic re-discovery of event tickers as markets roll over at local
# midnight. Replaces cron-based process restarts.
# NOT used by: synoptic/listener (stations are fixed per series)
# =============================================================================
event_rollover:
  # Used by: ticker.py, kalshi/listener, weather_bot
  # "active" = earliest close_time. "next" = earliest strike_date >= today
  # (local tz); excludes past events; picks tomorrow when today has closed.
  event_selection: "active"
  # Used by: kalshi/listener, weather_bot — re-query Kalshi for new events (sec). 0 = disable.
  rediscover_interval_seconds: 300

# =============================================================================
# STORAGE
# =============================================================================
# Parquet output and bot trade logs. data_dir is relative to config file.
# =============================================================================
storage:
  # Used by: kalshi/listener, synoptic/listener, weather_bot, research/weather/iem_awc_data_collector,
  #          run_weather_collection, weather_discrepancy_analysis
  data_dir: "../data"            # Relative to config file; ../data = project root
  # Used by: kalshi/listener, synoptic/listener, weather_bot
  flush_interval_seconds: 300    # Buffer flush to parquet (all services)

# =============================================================================
# KALSHI LISTENER — Snapshot collection
# =============================================================================
# Used by: kalshi/listener.py ONLY
# Controls how often and when Kalshi orderbook/ticker snapshots are written
# to Parquet. Spike detection triggers immediate snapshots on price moves.
# =============================================================================
collection:
  interval_seconds: 60           # kalshi/listener — baseline snapshot interval (seconds)
  spike_threshold_cents: 3      # kalshi/listener — snapshot when price moves ≥ this
  spike_cooldown_seconds: 2     # kalshi/listener — min sec between spike-triggered snapshots
  max_orderbook_depth: 5        # kalshi/listener — OB levels per side per contract; 0 = all
  baseline_every_n_snapshots: 60  # kalshi/listener — full OB baseline frequency; 1 = disable delta

# =============================================================================
# SYNOPTIC LISTENER — Weather data ingest
# =============================================================================
# Used by: synoptic/listener.py ONLY
# Stations are auto-derived from event_series.synoptic_listener via market
# registry. Override `stations` only if you need extra stations beyond the registry.
# =============================================================================
synoptic:
  # stations:  # optional override; omit → uses event_series.synoptic_listener → registry
  #   - KMDW1M
  #   - KNYC
  vars:        # Synoptic variables to subscribe to (e.g. air_temp)
    - air_temp

# =============================================================================
# WEATHER BOT — Paper trading strategy
# =============================================================================
# Used by: bot/weather_bot.py ONLY
# Strategy: when N consecutive 1-min ASOS obs ≥ cap_strike, buy NO contracts.
# =============================================================================
bot:
  execution_guardrails:
    starting_balance_cents: 100000  # Initial paper balance ($1,000)
    max_total_drawdown_cents: 10000 # Stop trading if total realized/paper loss exceeds $100
    max_allocation_per_series_cents: 20000 # Max exposure per city/series ($200)
  
  strategies:
    - id: "chicago_fast_ladder"
      class_name: "LadderStrategy"
      targets: 
        - "KXHIGHCHI"
      params:
        consecutive_obs: 2
        max_price_cents: 95

    - id: "ny_safe_ladder"
      class_name: "LadderStrategy"
      targets: 
        - "KXHIGHNY"
      params:
        consecutive_obs: 3
        max_price_cents: 90

